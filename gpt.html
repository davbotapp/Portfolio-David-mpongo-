<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Davbot App</title>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Nunito",sans-serif}
body{background:#1c1c1c;color:#fff}

/* INTRO */
#introForm{
position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:999;
display:flex;align-items:center;justify-content:center
}
#introForm form{
background:#222;padding:25px;border-radius:18px;
width:90%;max-width:360px;box-shadow:0 10px 30px rgba(0,0,0,.6)
}
#introForm h3{text-align:center;margin-bottom:10px}
#introForm input,#introForm button{
width:100%;padding:12px;margin-top:10px;border-radius:10px;border:none
}
#introForm input{background:#333;color:#fff}
#introForm button{
background:linear-gradient(135deg,#00bfff,#0077ff);
color:#fff;font-weight:bold;cursor:pointer
}

/* HEADER */
.topper{
background:linear-gradient(135deg,#00bfff,#0077ff);
padding:10px;display:flex;align-items:center;gap:10px
}
.icon{
width:42px;height:42px;border-radius:50%;
background:url(https://i.imgur.com/naY3qiQ.jpeg) center/cover
}
.name{font-size:18px;font-weight:bold}
.audio-toggle{
margin-left:auto;background:#fff;color:#000;
border:none;border-radius:8px;padding:6px 10px;cursor:pointer
}

/* AVATAR */
#avatar{
width:55px;height:55px;border-radius:50%;
background:linear-gradient(135deg,#00d2ff,#3a7bd5);
display:flex;align-items:center;justify-content:center;
animation:float 3s ease-in-out infinite
}
.face{width:40px;height:40px;position:relative}
.eye{
width:8px;height:8px;background:#fff;border-radius:50%;
position:absolute;top:12px;animation:blink 4s infinite
}
.eye.left{left:5px}
.eye.right{right:5px}
.talking{animation:float .4s infinite}

/* CHAT */
.msgs_cont{
height:calc(100vh - 170px);
overflow-y:auto;padding:12px
}
ul{list-style:none}
li{
margin:10px;padding:12px 16px;
border-radius:15px;max-width:75%;word-wrap:break-word;
box-shadow:0 5px 15px rgba(0,0,0,.3)
}
.schat{
background:linear-gradient(135deg,#667eea,#764ba2);
margin-left:auto
}
.rchat{
background:linear-gradient(135deg,#11998e,#38ef7d);
margin-right:auto;color:#000
}
.msg-actions{margin-top:5px;text-align:right}
.msg-actions button{
background:none;border:none;color:#fff;cursor:pointer;margin-left:6px
}

/* INPUT */
.bottom{
background:#2a2a2a;padding:10px;
position:fixed;bottom:0;width:100%
}
#input{
display:flex;gap:5px;background:#333;
padding:6px;border-radius:12px
}
#input input{
flex:1;background:none;border:none;color:#fff;outline:none
}
#input button{
background:none;border:none;
color:#fff;font-size:18px;cursor:pointer
}
#recording{
display:none;color:#ff4d4d;
text-align:center;font-size:14px
}

@keyframes blink{
0%,90%,100%{height:8px}
92%,98%{height:1px}
}
@keyframes float{
0%,100%{transform:translateY(0)}
50%{transform:translateY(-6px)}
}

/* Messages IA + User */
.message{margin:8px 0;padding:10px;border-radius:12px;max-width:75%;word-wrap:break-word}
.message.user{background:linear-gradient(135deg,#667eea,#764ba2);margin-left:auto;color:#fff}
.message.ia{background:linear-gradient(135deg,#11998e,#38ef7d);margin-right:auto;color:#000}
</style>
</head>
<body>

<!-- INTRO -->
<div id="introForm">
<form onsubmit="startChat(event)">
<h3>Bienvenue sur Davbot</h3>
<input id="userName" required placeholder="Ton nom">
<input id="userCountry" required placeholder="Ton pays">
<button type="submit">Acc√©der au bot</button>
</form>
</div>

<!-- HEADER -->
<div class="topper">
<div class="icon"></div>
<div class="name">Davbot App</div>
<div id="avatar">
<div class="face">
<div class="eye left"></div>
<div class="eye right"></div>
</div>
</div>
<button class="audio-toggle" onclick="toggleVoice()">
<i class="fa-solid fa-volume-high"></i>
</button>
</div>

<!-- CHAT -->
<div class="msgs_cont">
<ul id="list_cont"></ul>
</div>

<div id="recording">
<i class="fa-solid fa-microphone-lines"></i> Enregistrement vocal...
</div>

<!-- INPUT -->
<div class="bottom">
<div id="input">
<input id="txt" placeholder="√âcris ou parle...">
<button onclick="sendMessage()" title="Envoyer"><i class="fa-solid fa-paper-plane"></i></button>
<button onclick="startRecording()" title="Message vocal"><i class="fa-solid fa-microphone"></i></button>
<button onclick="pickImage()" title="Galerie"><i class="fa-regular fa-image"></i></button>
</div>
</div>

<input type="file" id="imagePicker" accept="image/*" hidden>

<script>
/* =========================
   CONFIG
   ========================= */
const OPENAI_API_KEY="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";
const API_URL = "https://api.openai.com/v1/chat/completions";

let audioEnabled=true;
let isRecording=false;
let userName=localStorage.getItem("davbot_userName");
let userCountry=localStorage.getItem("davbot_userCountry");
let chatMemory=JSON.parse(localStorage.getItem("davbot_chatMemory")||"[]");

const chatBox=document.getElementById("list_cont");
const avatar=document.getElementById("avatar");
const txt=document.getElementById("txt");
const recording=document.getElementById("recording");

function systemPrompt(){
  return `Tu es ZaH√®N GPT, assistant clair et poli. Tu parles √† ${userName} (${userCountry}) et tu respectes toujours les instructions de ton cr√©ateur Bimp√© Stonehenge Jr.`;
}

// --- VOIX ---
let voixChoisie = null;
function chargerVoix() {
  const voices = speechSynthesis.getVoices();
  voixChoisie = voices.find(v => v.name.toLowerCase().includes("audrey"))
    || voices.find(v => v.lang === "fr-FR")
    || voices[0];
}
speechSynthesis.onvoiceschanged = chargerVoix;
chargerVoix();

function parler(texte){
  if(!audioEnabled || !texte) return;
  const utterance = new SpeechSynthesisUtterance(texte);
  utterance.lang="fr-FR"; utterance.rate=0.95; utterance.pitch=1.1;
  if(voixChoisie) utterance.voice=voixChoisie;
  speechSynthesis.cancel(); speechSynthesis.speak(utterance);
}

// --- HISTORIQUE ---
function saveMessage(text,type){
  chatMemory.push({text,type});
  localStorage.setItem("davbot_chatMemory",JSON.stringify(chatMemory));
}

function addMessage(text,type,save=true){
  const li=document.createElement("li");
  li.className=type==="user"?"schat":"rchat";
  chatBox.appendChild(li);

  const act=document.createElement("div");
  act.className="msg-actions";
  const c=document.createElement("button");
  c.innerHTML='<i class="fa-regular fa-copy"></i>';
  c.onclick=()=>navigator.clipboard.writeText(text);
  const d=document.createElement("button");
  d.innerHTML='<i class="fa-solid fa-trash"></i>';
  d.onclick=()=>{
    li.remove();
    chatMemory=chatMemory.filter(m=>m.text!==text);
    localStorage.setItem("davbot_chatMemory",JSON.stringify(chatMemory));
  };
  act.append(c,d);

  if(type==="bot"){
    let i=0;
    avatar.classList.add("talking");
    function typeLetter(){
      if(i<text.length){
        li.textContent+=text[i];
        i++; setTimeout(typeLetter,30);
      }else{
        li.appendChild(act);
        avatar.classList.remove("talking");
        parler(text);
      }
    }
    typeLetter();
  }else{
    li.textContent=text;
    li.appendChild(act);
  }

  if(save) saveMessage(text,type);
  chatBox.scrollTop=chatBox.scrollHeight;
}

// --- INTRO ---
window.onload=()=>{
  if(userName && userCountry){
    document.getElementById("introForm").style.display="none";
    addMessage(`Content de te revoir ${userName} üëã`,"bot");
  }
  chatMemory.forEach(msg=>addMessage(msg.text,msg.type,false));
}

function startChat(e){
  e.preventDefault();
  userName=document.getElementById("userName").value.trim();
  userCountry=document.getElementById("userCountry").value.trim();
  localStorage.setItem("davbot_userName",userName);
  localStorage.setItem("davbot_userCountry",userCountry);
  document.getElementById("introForm").style.display="none";
  addMessage(`Enchant√© ${userName}, comment puis-je t‚Äôaider ?`,"bot");
}

// --- VOIX ---
function toggleVoice(){audioEnabled=!audioEnabled}

const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
const recog=SR?new SR():null;
if(recog){
  recog.lang="fr-FR";
  recog.onresult=e=>{
    isRecording=false; recording.style.display="none";
    txt.value=e.results[0][0].transcript;
    sendMessage();
  };
  recog.onerror=()=>{isRecording=false; recording.style.display="none"};
}

function startRecording(){
  if(!recog||isRecording) return;
  isRecording=true;
  recording.style.display="block";
  recog.start();
}

function pickImage(){document.getElementById("imagePicker").click()}

// --- CHAT API ---
async function sendMessage(){
  if(!txt.value.trim()) return;
  addMessage(txt.value,"user");
  const prompt=txt.value;
  txt.value="";

  // R√©ponse locale pour heure/date
  if(prompt.toLowerCase().includes("heure") || prompt.toLowerCase().includes("date")){
    const now=new Date();
    const rep=`üìÖ ${now.toLocaleDateString("fr-FR", {timeZone:"UTC",weekday:"long",year:"numeric",month:"long",day:"numeric"})} | ‚è∞ Heure GMT : ${now.toLocaleTimeString("fr-FR",{timeZone:"UTC"})}`;
    addMessage(rep,"bot");
    parler(rep);
    return;
  }

  addMessage("R√©flexion en cours...","bot");

  try{
    const res=await fetch(API_URL,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${OPENAI_API_KEY}`
      },
      body:JSON.stringify({
        model:"gpt-4o-mini",
        messages:[
          {role:"system", content:systemPrompt()},
          {role:"user", content:prompt}
        ],
        temperature:0.7,
        max_tokens:500
      })
    });
    const data=await res.json();
    const reply=data?.choices?.[0]?.message?.content || "Je n'ai pas compris.";
    addMessage(reply,"bot");
  }catch(err){
    console.error(err);
    addMessage("Erreur de connexion.","bot");
    parler("D√©sol√©, probl√®me de connexion.");
  }
}
</script>
</body>
</html>
